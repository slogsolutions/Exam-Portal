{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Portal</title>
<link href="{% static 'css/bootstrap.min.cssbootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
<script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

  <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; color: #333; }
      .exam-container { display: flex; min-height: 100vh; }

      /* Sidebar */
      .sidebar { width: 250px; background: linear-gradient(to bottom, #2e4e1f, #3a6126); color: #fff;
                 padding: 20px 15px; position: fixed; height: 100%; overflow-y: auto; box-shadow: 3px 0 10px rgba(0,0,0,0.1); }
      .sidebar-header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); }
      .sidebar h5 { color: #ffd700; margin: 0; font-size: 1.2rem; }
      .time-remaining { background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 5px; margin-top: 15px; font-size: 0.9rem; }
      .time-remaining span { font-weight: bold; color: #ffd700; }
      .question-nav { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }

      .question-btn {
          width: 28px; height: 28px; font-size: 0.75rem; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3);
          background: #f8f9fa; color: #333; display: flex; align-items: center; justify-content: center;
          transition: all 0.2s ease; padding: 0;
      }
      .question-btn:hover { transform: scale(1.05); border-color: #ffd700; }
      .question-btn.current { border: 2px solid #ffd700; }
      .question-btn.answered { background: #28a745; color: white; border-color: #1e7e34; }
      .question-btn.flagged { background: #dc3545; color: white; border-color: #bd2130; }

      .question-status { margin-top: 20px; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; }
      .status-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
      .status-color { width: 15px; height: 15px; border-radius: 50%; margin-right: 8px; }
      .status-answered { background: #28a745; }
      .status-flagged { background: #dc3545; }
      .status-not-answered { background: #f8f9fa; border: 1px solid #ccc; }

      .main-content { margin-left: 250px; padding: 30px; flex: 1; }
      .exam-header { background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                     margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
      .exam-title { color: #2e4e1f; margin: 0; font-weight: 600; }
      .question-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
      .question-text { font-size: 1.1rem; margin-bottom: 15px; color: #2c3e50; }
      .marks-badge { font-size: 0.85rem; padding: 5px 10px; border-radius: 20px; background: #e9f5e9; color: #2e4e1f; white-space: nowrap; }

      .options-container { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px 16px; margin: 20px 0; }
      .form-check { display: flex; align-items: flex-start; padding: 10px 12px; margin: 0; border-radius: 8px; border: 1px solid #eee; background: #fff; }
      .form-check:hover { background: #f8f9fa; }
      .form-check-input { margin-top: 0.25rem; cursor: pointer; }
      .form-check-label { width: 100%; padding-left: 10px; cursor: pointer; }

      .nav-controls { margin-top: 25px; display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
      .btn { padding: 8px 20px; border-radius: 6px; font-weight: 500; }
      .btn-primary { background: #2e4e1f; border-color: #2e4e1f; }
      .btn-warning { background: #ffc107; border-color: #ffc107; color: #212529; }
      .btn-success { background: #28a745; border-color: #28a745; }
  </style>
</head>

<body>
<div class="exam-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h5>Question Navigator</h5>
            <div class="time-remaining">
                <i class="far fa-clock"></i> Time Left: <span id="timer">02:30:00</span>
            </div>
        </div>

        {% if part_a %}
        <div class="question-nav">
            {% for question in part_a.questions.all %}
            <button type="button"
                    class="question-btn {% if forloop.first %}current{% endif %}"
                    id="nav-btn-{{ question.id }}"
                    onclick="showQuestion({{ forloop.counter0 }})">
                {{ forloop.counter }}
            </button>
            {% endfor %}
        </div>
        {% endif %}

        <div class="question-status">
            <div class="status-item"><div class="status-color status-answered"></div> Answered</div>
            <div class="status-item"><div class="status-color status-flagged"></div> Flagged</div>
            <div class="status-item"><div class="status-color status-not-answered"></div> Not Answered</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="exam-header">
            <h2 class="exam-title">Part A: Primary Exam</h2>
        </div>

        {% if part_a %}
        <!-- form now points to backend -->
        <form method="post" id="exam-form" action="{% url 'exam_interface' %}">
            {% csrf_token %}
            <input type="hidden" name="paper_id" value="{{ part_a.id }}">

            {% for question in part_a.questions.all %}
            <div class="question-card question-page" id="question-{{ forloop.counter0 }}" style="{% if not forloop.first %}display:none{% endif %}">
                <div class="d-flex justify-content-between align-items-start gap-3">
                    <h5 class="question-text mb-0">Q{{ forloop.counter }}. {{ question.text }}</h5>
                    <span class="marks-badge">{{ question.marks }} Marks</span>
                </div>

                <div class="options-container">
                    {% if question.part in "ABC" %}
                        {% for choice in question.options.choices %}
                            {% if choice %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio"
                                       name="question_{{ question.id }}"
                                       id="q{{ question.id }}_opt{{ forloop.counter }}"
                                       value="{{ choice }}"
                                       onchange="markAnswered({{ question.id }})">
                                <label class="form-check-label" for="q{{ question.id }}_opt{{ forloop.counter }}">{{ choice }}</label>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% elif question.part == "D" %}
                        <input type="text" name="question_{{ question.id }}" class="form-control"
                               placeholder="Enter your answer" onchange="markAnswered({{ question.id }})">
                    {% elif question.part == "E" %}
                        <textarea name="question_{{ question.id }}" rows="4" class="form-control"
                                  placeholder="Type your detailed answer" onchange="markAnswered({{ question.id }})"></textarea>
                    {% elif question.part == "F" %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_true" value="True" onchange="markAnswered({{ question.id }})">
                            <label class="form-check-label" for="q{{ question.id }}_true">True</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_false" value="False" onchange="markAnswered({{ question.id }})">
                            <label class="form-check-label" for="q{{ question.id }}_false">False</label>
                        </div>
                    {% endif %}
                </div>

                <div class="nav-controls">
                    {% if not forloop.first %}
                    <button type="button" class="btn btn-secondary" onclick="prevQuestion({{ forloop.counter0 }})">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-warning" onclick="flagQuestion({{ question.id }})">
                        <i class="fas fa-flag"></i> Flag
                    </button>
                    {% if not forloop.last %}
                    <button type="button" class="btn btn-primary" onclick="nextQuestion({{ forloop.counter0 }})">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    {% else %}
                    <button type="submit" class="btn btn-success" id="final-submit"><i class="fas fa-paper-plane"></i> Submit Exam</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </form>
        {% endif %}
    </div>
</div>

<script>
    let currentIndex = 0;

    {% if part_a %}
    const totalQuestions = {{ part_a.questions.count }};
    {% else %}
    const totalQuestions = 0;
    {% endif %}

    const answeredQuestions = new Set();
    const flaggedQuestions = new Set();

    function showQuestion(index) {
        document.querySelectorAll(".question-page").forEach((q) => q.style.display = "none");
        const target = document.getElementById("question-" + index);
        if (target) target.style.display = "block";

        document.querySelectorAll('.question-btn').forEach((btn, i) => {
            btn.classList.toggle('current', i === index);
        });

        currentIndex = index;
    }

    function nextQuestion(index) {
        if (index + 1 < totalQuestions) showQuestion(index + 1);
    }

    function prevQuestion(index) {
        if (index - 1 >= 0) showQuestion(index - 1);
    }

    function flagQuestion(qid) {
        const btn = document.getElementById("nav-btn-" + qid);
        if (!btn) return;

        if (flaggedQuestions.has(qid)) {
            btn.classList.remove("flagged");
            flaggedQuestions.delete(qid);
            if (answeredQuestions.has(qid)) btn.classList.add("answered");
        } else {
            btn.classList.add("flagged");
            btn.classList.remove("answered");
            flaggedQuestions.add(qid);
            answeredQuestions.delete(qid);
        }
    }

    function markAnswered(qid) {
        const btn = document.getElementById("nav-btn-" + qid);
        if (!btn) return;

        if (!flaggedQuestions.has(qid)) {
            btn.classList.add("answered");
            btn.classList.remove("flagged");
            answeredQuestions.add(qid);
        }
    }

    function startTimer(duration, display) {
        let timer = duration;
        const intervalId = setInterval(() => {
            const h = String(Math.floor(timer / 3600)).padStart(2,'0');
            const m = String(Math.floor((timer % 3600)/60)).padStart(2,'0');
            const s = String(timer % 60).padStart(2,'0');
            display.textContent = `${h}:${m}:${s}`;

            if (timer <= 0) {
                clearInterval(intervalId);
                alert("Time is up! Submitting your exam.");
                document.getElementById("exam-form").submit();
            }

            timer -= 1;
        }, 1000);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // âœ… use duration from Django view (seconds)
        const duration = {{ duration_seconds|default:0 }};
        const display = document.getElementById('timer');

        if (display && duration > 0) {
            startTimer(duration, display);
        }

        if (totalQuestions > 0) {
            showQuestion(0);
        }
    });
</script>
